#!/usr/bin/env node/** * speckit-to-prd.js - Convert GitHub Spec Kit output to Ralph's prd.json format *  * Uses GitHub Copilot CLI (like ralph-tui) to intelligently convert Spec Kit specs * to the prd.json format that Ralph understands. *  * Usage: node speckit-to-prd.js <path-to-spec-folder> * Example: node speckit-to-prd.js specs/001-restaurant-chatbot */import fs from 'fs/promises';import path from 'path';import { spawn } from 'child_process';// Colors for terminal outputconst colors = {  reset: '\x1b[0m',  green: '\x1b[32m',  yellow: '\x1b[33m',  red: '\x1b[31m',  cyan: '\x1b[36m'};function log(message, color = 'reset') {  console.log(`${colors[color]}${message}${colors.reset}`);}/** * Conversion prompt for Copilot CLI - based on ralph-tui's approach */const CONVERSION_PROMPT = `You are converting a GitHub Spec Kit specification to Ralph's prd.json format.## Your TaskRead the provided Spec Kit files (spec.md, tasks.md, plan.md) and generate a prd.json file that Ralph can execute.## CRITICAL: Output SchemaThe output MUST be a FLAT JSON object at the ROOT level. DO NOT wrap in a "prd" object or use "tasks" array.**REQUIRED Structure:**\`\`\`json{  "name": "Project Name",  "description": "Brief description",  "branchName": "ralph/###-feature-name",  "qualityCheck": "npm run build && npm test",  "userStories": [    {      "id": 1,      "title": "Story title",      "priority": 1,      "acceptanceCriteria": [        "Criterion from spec",        "Another criterion"      ],      "passes": false    }  ]}\`\`\`## Conversion Rules1. **Extract from spec.md**:   - Project name from # heading   - Description from overview section   - User stories from ### User Story N sections   - Acceptance criteria from **Acceptance Scenarios**: sections2. **User Stories**:   - Each "### User Story N" → one entry in userStories[]   - id: Sequential number (1, 2, 3...)   - title: Extract from "User Story N - Title"   - priority: Extract from "(Priority: PN)" → N   - acceptanceCriteria: Extract Given/When/Then scenarios as plain text3. **Optional enhancement from tasks.md**:   - Map tasks with [USN] markers to user stories   - Append as additional acceptance criteria with "Task:" prefix4. **Branch name**: Extract from folder path (specs/001-name → ralph/001-name)5. **Quality check**: Auto-detect from tech stack in description:   - TypeScript/React/Next → "npm run build && npm test"   - Python → "python -m pytest && python -m mypy ."   - Rust → "cargo test && cargo clippy"   - Go → "go test ./... && go vet ./..."   - Default → "echo 'No quality check configured'"6. **All stories**: Set "passes": false initially## Forbidden Patterns (DO NOT USE)\`\`\`json{  "prd": { ... },           // WRONG - no wrapper  "tasks": [ ... ],         // WRONG - use "userStories"  "subtasks": [ ... ],      // WRONG - not supported  "phases": [ ... ]         // WRONG - flatten to userStories}\`\`\`## Output Instructions1. Parse the provided spec files2. Generate the prd.json structure following the rules above3. Output ONLY the JSON object, nothing else4. Ensure valid JSON syntax`;/** * Call Copilot CLI to perform the conversion */async function convertWithCopilot(specContent, tasksContent, planContent) {  // Create temporary file with the full prompt  const tempDir = path.join(process.cwd(), '.tmp');  await fs.mkdir(tempDir, { recursive: true });    const promptFile = path.join(tempDir, 'conversion-prompt.txt');  const fullPrompt = `${CONVERSION_PROMPT}## Input Files### spec.md\`\`\`markdown${specContent}\`\`\`${tasksContent ? `### tasks.md\`\`\`markdown${tasksContent}\`\`\`` : ''}${planContent ? `### plan.md\`\`\`markdown${planContent}\`\`\`` : ''}Generate the prd.json now (output ONLY the JSON, no markdown code blocks):`;  await fs.writeFile(promptFile, fullPrompt, 'utf-8');  return new Promise((resolve, reject) => {    // Use shell to pipe the prompt file to copilot    const isWindows = process.platform === 'win32';    const command = isWindows       ? `type "${promptFile}" | copilot`      : `cat "${promptFile}" | copilot`;    const shell = spawn(command, [], {      stdio: ['inherit', 'pipe', 'pipe'],      shell: true    });    let output = '';    let error = '';    shell.stdout.on('data', (data) => {      output += data.toString();    });    shell.stderr.on('data', (data) => {      error += data.toString();    });    shell.on('close', async (code) => {      // Cleanup temp file      try {        await fs.unlink(promptFile);        await fs.rmdir(tempDir);      } catch (e) {        // Ignore cleanup errors      }      if (code !== 0) {        reject(new Error(`Copilot CLI exited with code ${code}: ${error}`));      } else {        // Extract JSON from output (Copilot might add explanatory text)        const jsonMatch = output.match(/\{[\s\S]*\}/);        if (jsonMatch) {          try {            const parsed = JSON.parse(jsonMatch[0]);            resolve(parsed);          } catch (e) {            reject(new Error(`Failed to parse Copilot output as JSON: ${e.message}\nOutput: ${output}`));          }        } else {          reject(new Error(`No JSON found in Copilot output: ${output}`));        }      }    });    shell.on('error', (err) => {      reject(new Error(`Failed to run Copilot CLI: ${err.message}`));    });  });}/** * Main conversion function */async function convertSpecKitToPrd(specFolderPath) {  log('\n╔════════════════════════════════════════╗', 'cyan');  log('║   Spec Kit → Ralph PRD Converter      ║', 'cyan');  log('║        (AI-Powered via Copilot)        ║', 'cyan');  log('╚════════════════════════════════════════╝\n', 'cyan');    // Validate spec folder exists  try {    await fs.access(specFolderPath);  } catch {    log(`ERROR: Spec folder not found: ${specFolderPath}`, 'red');    process.exit(1);  }    const specPath = path.join(specFolderPath, 'spec.md');  const tasksPath = path.join(specFolderPath, 'tasks.md');  const planPath = path.join(specFolderPath, 'plan.md');    // Check if spec.md exists (required)  try {    await fs.access(specPath);  } catch {    log(`ERROR: spec.md not found in ${specFolderPath}`, 'red');    log('Run Spec Kit commands first: /speckit.specify, /speckit.plan, /speckit.tasks', 'yellow');    process.exit(1);  }    log(`Reading: ${specPath}`, 'yellow');  const specContent = await fs.readFile(specPath, 'utf-8');    // Optional files  let tasksContent = null;  let planContent = null;    try {    await fs.access(tasksPath);    log(`Reading: ${tasksPath}`, 'yellow');    tasksContent = await fs.readFile(tasksPath, 'utf-8');  } catch {    log('tasks.md not found (optional)', 'yellow');  }    try {    await fs.access(planPath);    log(`Reading: ${planPath}`, 'yellow');    planContent = await fs.readFile(planPath, 'utf-8');  } catch {    log('plan.md not found (optional)', 'yellow');  }    log('\nConverting with Copilot CLI...', 'yellow');  log('(This uses AI to intelligently map Spec Kit → Ralph format)\n', 'cyan');    try {    const prd = await convertWithCopilot(specContent, tasksContent, planContent);        // Validate basic structure    if (!prd.name || !prd.userStories || !Array.isArray(prd.userStories)) {      throw new Error('Generated prd.json is missing required fields (name, userStories)');    }        if (prd.userStories.length === 0) {      throw new Error('No user stories found in generated prd.json');    }        // Write prd.json    const outputPath = path.join(process.cwd(), 'prd.json');    await fs.writeFile(outputPath, JSON.stringify(prd, null, 2));        log(`\n✓ Generated: ${outputPath}`, 'green');    log(`\nProject: ${prd.name}`, 'cyan');    log(`Branch: ${prd.branchName || 'not specified'}`, 'cyan');    log(`User Stories: ${prd.userStories.length}`, 'cyan');    log(`\nReady to run Ralph!`, 'yellow');    log(`  bash ralph.sh`, 'cyan');    log(`  powershell -File ralph.ps1\n`, 'cyan');      } catch (error) {    log(`\nERROR: Conversion failed`, 'red');    log(error.message, 'red');    log('\nTroubleshooting:', 'yellow');    log('1. Ensure GitHub Copilot CLI is installed: npm install -g @githubnext/github-copilot-cli', 'yellow');    log('2. Ensure you are authenticated: copilot auth', 'yellow');    log('3. Check that spec.md has user stories in Spec Kit format', 'yellow');    process.exit(1);  }}// CLI entry pointconst args = process.argv.slice(2);if (args.length === 0) {  log('\nUsage: node speckit-to-prd.js <path-to-spec-folder>', 'yellow');  log('Example: node speckit-to-prd.js specs/001-restaurant-chatbot\n', 'cyan');  log('This tool uses GitHub Copilot CLI to intelligently convert Spec Kit specs to prd.json', 'cyan');  log('(Similar to how ralph-tui uses AI skills for conversions)\n', 'cyan');  process.exit(1);}convertSpecKitToPrd(args[0]).catch(error => {  log(`\nFATAL ERROR: ${error.message}`, 'red');  process.exit(1);});